# docker-compose.yml - Media Stack (Plex + *arr + NZB + Overseerr + Pi-hole + Traefik + Prowlarr)
# Run with: docker compose up -d
# Location: ~/ums
# Subdomains: *.local via Traefik (HTTPS)
# Direct ports are commented out - all access should go through Traefik (except Plex which uses host network)
# logs are centralized to ~/ums/tmp/logs/<app> for easy host access and debugging
# Date: Janvier 2026 - Version sécurisée avec IP whitelist + auth basique

networks:
  default:
    driver: bridge
    name: ums_default  # Réseau dédié pour isolation et Traefik

services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true  # Empêche l'escalade de privilèges
    ports:
      - "80:80"     # HTTP → redirect vers HTTPS
      - "443:443"   # HTTPS principal
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Traefik détecte les containers     
      - ${TMP_DIR}/logs/traefik:/logs             # logs Traefik sur host
      - ${APP_DIR}/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ${APP_DIR}/traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - ${APP_DIR}/traefik/certs:/certs:ro  # Certs mkcert self-signed
    command:
      - --api=true
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=ums_default
      - --providers.file.filename=/etc/traefik/dynamic.yml
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.websecure.address=:443
      - --log.level=INFO
    networks:
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.local`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.middlewares=internal-ipwhitelist@file,auth@file"

  plex:
    image: ghcr.io/linuxserver/plex:latest
    container_name: plex
    network_mode: host  # Nécessaire pour discovery, direct play et accès externe (IP:32400)
    environment:
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - VERSION=docker
      - PLEX_CLAIM=
    volumes:
      - ${APP_DIR}/plex/config:/config                    # Config + DB Plex
      - ${PLEX_DIR}/Series:/Series                        # Séries
      - ${PLEX_DIR}/Movies:/Movies                        # Films
      - ${APP_DIR}/plex/certs:/certs:ro
      - ${TMP_DIR}/logs/plex:/config/Library/Application Support/Plex Media Server/Logs
      - /dev/shm:/ramtranscode                             # Transcode RAM      
    restart: unless-stopped
    devices:
      - /dev/dri:/dev/dri  # Accélération hardware

  nzbget:
    image: linuxserver/nzbget:latest
    container_name: nzbget
    restart: unless-stopped
    environment:
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
    volumes:
      - ${APP_DIR}/nzbget/config:/config                  # Config NZBGet
      - ${TMP_DIR}/downloads:/downloads                   # Téléchargements
      - ${TMP_DIR}/logs/nzbget:/config/logs               # logs NZBGet sur host
    # ports:
    #   - "6789:6789"  # Commenté - accès via Traefik uniquement
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nzbget.rule=Host(`nzbget.local`)"
      - "traefik.http.routers.nzbget.entrypoints=websecure"
      - "traefik.http.routers.nzbget.tls=true"
      - "traefik.http.services.nzbget.loadbalancer.server.port=6789"
      - "traefik.http.routers.nzbget.middlewares=internal-ipwhitelist@file"
    networks:
      - default

  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    environment:
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
    volumes:
      - ${APP_DIR}/sonarr/config:/config                  # Config Sonarr
      - ${TMP_DIR}/downloads:/downloads                   # Téléchargements
      - ${PLEX_DIR}/Series:/Series                        # Séries
      - ${TMP_DIR}/logs/sonarr:/config/logs               # logs Sonarr sur host
    # ports:
    #   - "8989:8989"  # Commenté - accès via Traefik uniquement
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.local`)"
      - "traefik.http.routers.sonarr.entrypoints=websecure"
      - "traefik.http.routers.sonarr.tls=true"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"
      - "traefik.http.routers.sonarr.middlewares=internal-ipwhitelist@file,auth@file"
    networks:
      - default

  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    environment:
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
    volumes:
      - ${APP_DIR}/radarr/config:/config                  # Config Radarr
      - ${TMP_DIR}/downloads:/downloads                   # Téléchargements
      - ${PLEX_DIR}/Movies:/Movies                        # Films
      - ${TMP_DIR}/logs/radarr:/config/logs               # logs Radarr sur host
    # ports:
    #   - "7878:7878"  # Commenté - accès via Traefik uniquement
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.radarr.rule=Host(`radarr.local`)"
      - "traefik.http.routers.radarr.entrypoints=websecure"
      - "traefik.http.routers.radarr.tls=true"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"
      - "traefik.http.routers.radarr.middlewares=internal-ipwhitelist@file,auth@file"
    networks:
      - default

  # nzbhydra block commented out - not used anymore
  # nzbhydra:
  #   image: ghcr.io/hotio/nzbhydra2:latest
  #   container_name: nzbhydra
  #   restart: unless-stopped
  #   environment:
  #     - PUID=${USER_ID}
  #     - PGID=${GROUP_ID}
  #     - TZ=${TIMEZONE}
  #   volumes:
  #     - ${APP_DIR}/nzbhydra2/config:/config
  #     - ${TMP_DIR}/logs/nzbhydra:/config/logs
  #   # ports:
  #   #   - "5076:5076"
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.nzbhydra.rule=Host(`nzbhydra.local`)"
  #     - "traefik.http.routers.nzbhydra.entrypoints=websecure"
  #     - "traefik.http.routers.nzbhydra.tls=true"
  #     - "traefik.http.services.nzbhydra.loadbalancer.server.port=5076"
  #     - "traefik.http.routers.nzbhydra.middlewares=internal-ipwhitelist@file,auth@file"
  #   networks:
  #     - default

  overseerr:
    image: sctx/overseerr:latest
    container_name: overseerr
    restart: unless-stopped
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
    volumes:
      - ${APP_DIR}/overseerr/config:/app/config           # Config Overseerr
      - ${TMP_DIR}/logs/overseerr:/app/config/logs        # logs Overseerr sur host (si activé dans settings)
    # ports:
    #   - "5055:5055"  # Commenté - accès via Traefik uniquement
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.overseerr.rule=Host(`overseerr.local`)"
      - "traefik.http.routers.overseerr.entrypoints=websecure"
      - "traefik.http.routers.overseerr.tls=true"
      - "traefik.http.services.overseerr.loadbalancer.server.port=5055"
      - "traefik.http.routers.overseerr.middlewares=internal-ipwhitelist@file,auth@file,overseerr-strip@file"	
      #- "traefik.http.routers.overseerr.middlewares=internal-ipwhitelist@file,auth@file"

    networks:
      - default

  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    environment:
      TZ: ${TIMEZONE}
      FTLCONF_webserver_api_password: Kfd932mdDc3245..324!
      FTLCONF_dns_upstreams: '1.1.1.1;8.8.8.8'
      FTLCONF_webserver_port: 80
      FTLCONF_dns_listeningMode: 'ALL'
      FTLCONF_dns_reply_host_IPv4: '192.168.1.6'
    volumes:
      - ${APP_DIR}/pihole/etc-pihole:/etc/pihole          # Config Pi-hole
      - ${APP_DIR}/pihole/etc-dnsmasq.d:/etc/dnsmasq.d    # Custom DNS
      - ${APP_DIR}/traefik:/etc/traefik:ro                # ? (votre choix)
      - ${TMP_DIR}/logs/pihole:/var/log/pihole            # logs Pi-hole sur host
    cap_add:
      - NET_ADMIN
    ports:
      - "53:53/tcp"     # DNS obligatoire
      - "53:53/udp"     # DNS obligatoire
      # - "67:67/udp"   # DHCP si utilisé
      # - "8080:80"     # Web admin direct - commenté si accès via Traefik uniquement
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pihole.rule=Host(`pihole.local`)"
      - "traefik.http.routers.pihole.entrypoints=websecure"
      - "traefik.http.routers.pihole.tls=true"
      - "traefik.http.services.pihole.loadbalancer.server.port=80"
      - "traefik.http.routers.pihole.middlewares=internal-ipwhitelist@file,auth@file"
    networks:
      - default
    healthcheck:
      test: ["CMD", "pidof", "pihole-FTL"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    environment:
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
    volumes:
      - ${APP_DIR}/prowlarr/config:/config                # Config Prowlarr
      - ${TMP_DIR}/logs/prowlarr:/config/logs             # logs Prowlarr sur host
    # ports:
    #   - "9696:9696"  # Commenté - accès via Traefik uniquement
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.local`)"
      - "traefik.http.routers.prowlarr.entrypoints=websecure"
      - "traefik.http.routers.prowlarr.tls=true"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"
      - "traefik.http.routers.prowlarr.middlewares=internal-ipwhitelist@file,auth@file"
    networks:
      - default
  kometa:
    image: kometateam/kometa:latest
    container_name: kometa
    restart: no              # Garder le container up pour le scheduler
    deploy:
      resources:
        limits:
          cpus: '0.20'      # Limit CPU
          memory: 1536M    # Limit RAM   
    environment:
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - KOMETA_RUN=true
      #- KOMETA_TIME=never                # Run tous les jours à 3h du matin (format HH:MM)
    volumes:
      - ${APP_DIR}/kometa/config:/config  # Config + assets + logs
      - ${TMP_DIR}/logs/kometa:/config/logs
    # Pas de second volume logs (plus simple et évite bugs chemins)
    # Pas de ports/UI — CLI only
    # Pas de Traefik labels — pas besoin d'accès web
